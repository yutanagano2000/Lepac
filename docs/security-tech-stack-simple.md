# セキュリティ相談用 技術スタック概要

**システム名**: 太陽光発電 案件管理システム
**作成日**: 2026-02-10

---

## このシステムは何をするもの？

太陽光発電の案件（土地情報・地権者・工事進捗など）を **複数の組織で管理する業務用Webアプリ** です。
地図表示・3D地形表示・ファイル管理・スケジュール管理などの機能を持ちます。

---

## 全体像

```
                        ┌─────────────────────────────────┐
                        │        利用者のブラウザ            │
                        │   (PC / スマートフォン)            │
                        └──────────┬──────────────────────┘
                                   │ HTTPS通信のみ
                                   ▼
┌──────────────────────────────────────────────────────────────────┐
│                    Vercel (ホスティング)                          │
│                                                                  │
│  ┌──────────────┐    ┌────────────────────────────────────────┐  │
│  │  入口の門番    │    │        アプリ本体 (Next.js)             │  │
│  │              │    │                                        │  │
│  │ ・IP制限     │───>│  画面表示 (53ページ)                     │  │
│  │ ・ログイン確認 │    │  API (53エンドポイント)                  │  │
│  │              │    │  ファイル管理                            │  │
│  └──────────────┘    └───────┬──────┬──────┬──────┬───────────┘  │
└──────────────────────────────┼──────┼──────┼──────┼──────────────┘
                               │      │      │      │
              ┌────────────────┘      │      │      └────────────────┐
              ▼                       ▼      ▼                       ▼
     ┌──────────────┐     ┌────────────┐ ┌────────────┐    ┌──────────────┐
     │   Turso DB   │     │  Vercel    │ │  Supabase  │    │  外部サービス  │
     │              │     │  Blob      │ │  Storage   │    │              │
     │ 案件データ    │     │            │ │            │    │ ・LINE Login │
     │ ユーザー情報  │     │ ファイル    │ │ ファイル    │    │ ・Google     │
     │ 監査ログ     │     │ 保存(メイン) │ │ 保存(旧)   │    │  Sheets     │
     │              │     │            │ │            │    │ ・国土地理院  │
     └──────────────┘     └────────────┘ └────────────┘    └──────────────┘
```

---

## 扱っているデータの種類

### 個人情報・機密データ

| データ | 具体例 | 保存場所 |
|--------|--------|----------|
| ユーザー認証情報 | パスワード(暗号化済み), メール, LINE ID | Turso DB |
| 地権者の個人情報 | 氏名, 住所 | Turso DB |
| 土地・費用情報 | 座標, 土地代, 各種費用 | Turso DB |
| 業務文書ファイル | 登記簿謄本, 公図, 同意書, 図面 | Vercel Blob / Supabase |
| 工事写真 | 現場写真, 施工者名 | Vercel Blob |
| アクセスログ | IPアドレス, ブラウザ情報, 操作履歴 | Turso DB |

---

## ログインの仕組み

```
 ログイン方法は3つ
 ─────────────────

 1) ID + パスワード ──> パスワードは暗号化して保存 (bcrypt)
                        12文字以上・大小英数字+記号 必須

 2) LINE ログイン ────> LINEアカウントで認証 (OAuth)
                        初回は自動でユーザー作成

 3) モバイルアプリ ──> 専用トークン発行 (JWT, 7日間有効)
```

### ログイン後のアクセス制御

```
 ユーザーがデータにアクセスするまでの4段階チェック
 ──────────────────────────────────────────────

  [リクエスト]
      │
      ▼
  (1) IP制限 ────── 許可されたIPアドレスか？        ── NG → 遮断
      │
      ▼
  (2) ログイン確認 ─ 有効なセッションがあるか？      ── NG → ログイン画面へ
      │
      ▼
  (3) 組織チェック ─ いずれかの組織に所属しているか？ ── NG → 組織選択画面へ
      │
      ▼
  (4) データ所有権 ─ 自分の組織のデータか？          ── NG → 403エラー
      │
      ▼
  [データ表示]
```

### 権限の種類

| 権限 | できること |
|------|-----------|
| 一般ユーザー (user) | 自分の組織のデータ閲覧・編集 |
| 管理者 (admin) | 上記 + ユーザー管理 + 組織切替 |

---

## セキュリティ対策の一覧

### 不正アクセス防止

| 対策 | 何を防ぐか | どうやって |
|------|-----------|-----------|
| IP制限 | 不明な場所からのアクセス | 許可IPリストと照合 |
| レート制限 | 総当たり攻撃 | ログイン: 5回/5分、API: 100回/分 |
| CSRF保護 | 偽のリクエスト送信 | Origin/Refererヘッダー検証 |
| パスワードポリシー | 弱いパスワード | 12文字+複雑性要件 |
| 暗号化通信 | 盗聴 | HTTPS必須 (HSTS有効) |

### データ保護

| 対策 | 何を防ぐか | どうやって |
|------|-----------|-----------|
| マルチテナント分離 | 他組織のデータ閲覧 | 全クエリに組織IDフィルター |
| パスワード暗号化 | パスワード漏洩 | bcryptハッシュ化 |
| 入力値検証 | SQLインジェクション等 | Zodスキーマ + カスタム検証 |
| ファイル名サニタイズ | パストラバーサル | 危険文字の除去 + パス検証 |
| HTMLタグ除去 | XSS (スクリプト注入) | 入力テキストのサニタイズ |
| 監査ログ | 不正操作の追跡 | 全操作をIPアドレス付きで記録 |

### ブラウザ保護 (セキュリティヘッダー)

| ヘッダー | 効果 |
|---------|------|
| HSTS | HTTPS接続を強制 |
| X-Frame-Options | 他サイトへの埋め込み禁止 (クリックジャッキング防止) |
| CSP | 読み込めるスクリプト・画像等を制限 |
| X-Content-Type-Options | ファイル種別の誤認防止 |
| Permissions-Policy | カメラ・マイク等のアクセス制限 |

---

## 外部サービスとの接続

| サービス | 何に使っているか | 認証方法 | データの流れ |
|---------|----------------|---------|-------------|
| **Turso** | メインのデータベース | トークン認証 | 読み書き (全データ) |
| **Vercel Blob** | ファイル保存 (メイン) | トークン認証 | アップロード/ダウンロード |
| **Supabase Storage** | ファイル保存 (旧) | 管理者キー | アップロード/ダウンロード |
| **LINE Login** | ソーシャルログイン | OAuth 2.0 | ユーザープロフィール取得 |
| **Google Sheets** | データ同期 (日次) | サービスアカウント | 案件データの書き出し |
| **国土地理院** | 地図タイル画像 | 不要 (公開) | 画像の読み込みのみ |
| **Cesium Ion** | 3D地形データ | 公開トークン | 地形データの読み込みのみ |

---

## シークレット (秘密鍵) の管理

```
 保管場所: Vercel 環境変数 + ローカル .env.local (Git管理外)
 合計: 16個のシークレット
 ─────────────────────────────────────────────

 認証系 (3個)
   AUTH_SECRET              ... セッション署名キー
   LINE_CLIENT_ID           ... LINE連携用
   LINE_CLIENT_SECRET       ... LINE連携用

 データベース (2個)
   TURSO_DATABASE_URL       ... DB接続先
   TURSO_AUTH_TOKEN         ... DB認証

 ストレージ (3個)
   SUPABASE_URL             ... Supabase接続先
   SUPABASE_SERVICE_ROLE_KEY... Supabase管理者キー ※最高権限
   BLOB_READ_WRITE_TOKEN    ... Vercel Blob用

 Google連携 (4個)
   GOOGLE_SERVICE_ACCOUNT_EMAIL
   GOOGLE_PRIVATE_KEY       ... ※秘密鍵
   GOOGLE_SHEETS_SPREADSHEET_ID
   GOOGLE_SHEETS_SHEET_NAME

 セキュリティ設定 (3個)
   CRON_SECRET              ... 定期実行の認証
   ALLOWED_IPS              ... IP許可リスト
   IP_RESTRICTION_ENABLED   ... IP制限の有効/無効

 公開トークン (1個)
   NEXT_PUBLIC_CESIUM_ION_TOKEN ... ブラウザに公開される
```

---

## ファイルのアップロード・ダウンロード

### アップロード時のチェック

```
 ファイル選択
     │
     ▼
 (1) ファイル種類チェック ─── JPEG/PNG/GIF/WebP/PDF のみ許可
     │
     ▼
 (2) サイズチェック ───────── 通常10MB / 写真20MB まで
     │
     ▼
 (3) ファイル名の無害化 ──── 危険な文字を除去
     │
     ▼
 (4) ユニークな名前を付与 ── UUID + タイムスタンプ
     │
     ▼
 (5) 保存 ────────────────── Vercel Blob または Supabase
```

### ダウンロード時のチェック

```
 ダウンロード要求
     │
     ▼
 (1) ログイン確認 + 組織チェック + プロジェクト所有権
     │
     ▼
 (2) ファイルパスの安全性検証 (パストラバーサル防止)
     │
     ▼
 (3) 期限付きURL発行 (Supabase: 1時間 / Blob: 直接)
```

---

## 相談したいポイント (検討事項)

### 優先度: 高

| # | 項目 | 現状 | 懸念点 |
|---|------|------|--------|
| 1 | CSPの緩和設定 | スクリプト実行に `unsafe-eval` `unsafe-inline` を許可中 | XSS攻撃の緩和効果が低下。ライブラリ要件で外せない |
| 2 | ファイル公開モード | Vercel BlobがURL直接アクセス可能な公開モード | DB削除後もURLを知っていればアクセス可能 |
| 3 | 認証ライブラリがベータ版 | NextAuth.js v5 (beta.30) を使用中 | 正式リリース前のため未知の脆弱性リスク |

### 優先度: 中

| # | 項目 | 現状 | 懸念点 |
|---|------|------|--------|
| 4 | IPアドレスのハードコード | ソースコードに3件のIP直書き | 変更時にデプロイが必要、監査証跡なし |
| 5 | 監査ログの保持期間 | 無期限で蓄積中 | ストレージ圧迫、個人情報保護法との兼ね合い |
| 6 | 2要素認証なし | パスワードのみ | 管理者アカウント乗っ取りリスク |

### 優先度: 低

| # | 項目 | 現状 | 懸念点 |
|---|------|------|--------|
| 7 | CORSポリシー未定義 | Same-Originのみ | モバイルアプリ正式対応時に要設定 |
| 8 | シークレットの環境分離 | 本番/開発で同じ管理方法 | 開発環境からの漏洩リスク |

---

## 技術スタック まとめ表

| 分類 | 技術名 | バージョン | 役割 |
|------|--------|-----------|------|
| **Webフレームワーク** | Next.js | 16.1.2 | アプリ本体 |
| **言語** | TypeScript | 5.9.3 | 型安全な開発 |
| **UI** | React | 19.2.3 | 画面描画 |
| **UIコンポーネント** | shadcn/ui + Radix UI | - | ボタン・フォーム等 |
| **CSS** | Tailwind CSS | 4.x | スタイリング |
| **データベース** | Turso (SQLite) | - | データ保存 |
| **ORM** | Drizzle ORM | 0.45.1 | DB操作 |
| **認証** | NextAuth.js | 5.0.0-beta.30 | ログイン管理 |
| **JWT** | jose | 6.1.3 | モバイル認証トークン |
| **パスワード** | bcryptjs | 3.0.3 | パスワード暗号化 |
| **ファイル保存** | Vercel Blob | 0.27.1 | ファイルストレージ |
| **ファイル保存(旧)** | Supabase Storage | 2.93.3 | ファイルストレージ |
| **地図** | Leaflet + react-leaflet | 1.9.4 / 5.0.0 | 地図表示・描画 |
| **3D表示** | Three.js + R3F | 0.182.0 | 3D地形ビューワー |
| **グラフ** | Plotly.js | 3.3.1 | データ可視化 |
| **画像処理** | sharp | 0.34.5 | サーバー側画像変換 |
| **PDF** | jsPDF + pdfjs-dist | 4.1.0 / 5.4.624 | PDF生成・表示 |
| **Excel** | ExcelJS | 4.4.0 | Excel出力 |
| **Google連携** | googleapis | 171.4.0 | Sheets同期 |
| **バリデーション** | Zod (内蔵) | - | 入力値検証 |
| **ホスティング** | Vercel | - | デプロイ・CDN |
| **テスト** | Vitest + Playwright | 4.0.18 / 1.58.1 | 自動テスト |

---

*詳細な技術資料: [security-tech-stack.md](./security-tech-stack.md) を参照*
*本資料に実際のパスワード・トークン等の秘密情報は含まれていません。*
