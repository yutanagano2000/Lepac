name: PR Review Report

on:
  pull_request:
    branches: [develop, master]

jobs:
  review:
    name: Auto Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        id: lint
        continue-on-error: true
        run: |
          npm run lint 2>&1 | tee lint-output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"

      - name: Run TypeScript Check
        id: typecheck
        continue-on-error: true
        run: |
          npx tsc --noEmit 2>&1 | tee typecheck-output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"

      - name: Run Unit Tests
        id: test
        continue-on-error: true
        run: |
          npm run test:run 2>&1 | tee test-output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"

      - name: Run Build
        id: build
        continue-on-error: true
        run: |
          npm run build 2>&1 | tee build-output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"
        env:
          SKIP_ENV_VALIDATION: true
          TURSO_DATABASE_URL: "libsql://dummy-for-ci"
          TURSO_AUTH_TOKEN: "dummy"
          NEXTAUTH_SECRET: "ci-dummy-secret"
          NEXTAUTH_URL: "http://localhost:3000"

      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const lint = '${{ steps.lint.outputs.exit_code }}' === '0';
            const typecheck = '${{ steps.typecheck.outputs.exit_code }}' === '0';
            const test = '${{ steps.test.outputs.exit_code }}' === '0';
            const build = '${{ steps.build.outputs.exit_code }}' === '0';

            const icon = (ok) => ok ? '✅' : '❌';
            const allPassed = lint && typecheck && test && build;

            let body = `## ${allPassed ? '✅' : '❌'} Auto Review Report\n\n`;
            body += `| Check | Result |\n|-------|--------|\n`;
            body += `| ESLint | ${icon(lint)} |\n`;
            body += `| TypeScript | ${icon(typecheck)} |\n`;
            body += `| Unit Tests | ${icon(test)} |\n`;
            body += `| Build | ${icon(build)} |\n\n`;

            if (!lint) {
              const output = fs.readFileSync('lint-output.txt', 'utf8').slice(-2000);
              body += `<details><summary>❌ ESLint Errors</summary>\n\n\`\`\`\n${output}\n\`\`\`\n</details>\n\n`;
            }
            if (!typecheck) {
              const output = fs.readFileSync('typecheck-output.txt', 'utf8').slice(-2000);
              body += `<details><summary>❌ TypeScript Errors</summary>\n\n\`\`\`\n${output}\n\`\`\`\n</details>\n\n`;
            }
            if (!test) {
              const output = fs.readFileSync('test-output.txt', 'utf8').slice(-2000);
              body += `<details><summary>❌ Test Failures</summary>\n\n\`\`\`\n${output}\n\`\`\`\n</details>\n\n`;
            }
            if (!build) {
              const output = fs.readFileSync('build-output.txt', 'utf8').slice(-2000);
              body += `<details><summary>❌ Build Errors</summary>\n\n\`\`\`\n${output}\n\`\`\`\n</details>\n\n`;
            }

            if (allPassed) {
              body += `> 全チェック通過。レビュー＆マージ可能です。\n`;
            } else {
              body += `> 修正が必要です。エラー詳細を確認してください。\n`;
            }

            // Delete previous bot comments
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            for (const comment of comments.data) {
              if (comment.body.includes('Auto Review Report')) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id,
                });
              }
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body,
            });
